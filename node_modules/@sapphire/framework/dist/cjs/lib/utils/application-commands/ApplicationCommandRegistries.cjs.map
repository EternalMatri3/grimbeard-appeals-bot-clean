{"version":3,"sources":["../../../../../src/lib/utils/application-commands/ApplicationCommandRegistries.ts"],"names":["defaultBehaviorWhenNotIdentical","RegisterBehavior","defaultGuildIds","ApplicationCommandRegistry","container","Events","emitPerRegistryError","getNeededRegistryParameters","retry","bulkOverwriteDebug","ApplicationCommandType","InternalRegistryAPIType","bulkOverwriteWarn","bulkOverwriteInfo","emitBulkOverwriteError"],"mappings":"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","file":"ApplicationCommandRegistries.cjs","sourcesContent":["/* eslint-disable @typescript-eslint/dot-notation */\nimport { container } from '@sapphire/pieces';\nimport { retry } from '@sapphire/utilities';\nimport type { RESTPostAPIApplicationCommandsJSONBody } from 'discord-api-types/v10';\nimport { ApplicationCommandType, type ApplicationCommandManager } from 'discord.js';\nimport type { Command } from '../../structures/Command';\nimport type { CommandStore } from '../../structures/CommandStore';\nimport { InternalRegistryAPIType, RegisterBehavior } from '../../types/Enums';\nimport { Events } from '../../types/Events';\nimport { ApplicationCommandRegistry } from './ApplicationCommandRegistry';\nimport { getNeededRegistryParameters } from './getNeededParameters';\nimport { emitBulkOverwriteError, emitPerRegistryError } from './registriesErrors';\nimport { bulkOverwriteDebug, bulkOverwriteInfo, bulkOverwriteWarn } from './registriesLog';\n\nexport let defaultBehaviorWhenNotIdentical = RegisterBehavior.Overwrite;\nexport let defaultGuildIds: ApplicationCommandRegistry.RegisterOptions['guildIds'] = undefined;\nlet bulkOVerwriteRetries = 1;\n\nexport const registries = new Map<string, ApplicationCommandRegistry>();\n\nexport const allGuildIdsToFetchCommandsFor = new Set<string>();\n\n/**\n * Acquires a registry for a command by its name.\n * @param commandName The name of the command.\n * @returns The application command registry for the command\n */\nexport function acquire(commandName: string) {\n\tconst existing = registries.get(commandName);\n\tif (existing) {\n\t\treturn existing;\n\t}\n\n\tconst newRegistry = new ApplicationCommandRegistry(commandName);\n\tregistries.set(commandName, newRegistry);\n\n\treturn newRegistry;\n}\n\n/**\n * Sets the default behavior when registered commands aren't identical to provided data.\n * @param behavior The default behavior to have. Set this to `null` to reset it to the default\n * of `RegisterBehavior.Overwrite`.\n */\nexport function setDefaultBehaviorWhenNotIdentical(behavior?: RegisterBehavior | null) {\n\tdefaultBehaviorWhenNotIdentical = behavior ?? RegisterBehavior.Overwrite;\n}\n\nexport function getDefaultBehaviorWhenNotIdentical() {\n\treturn defaultBehaviorWhenNotIdentical;\n}\n\n/**\n * Sets the default guild ids for registering commands. This is used when a command is registered _without_ providing\n * `guildIds` in that command's own {@link Command.registerApplicationCommands} method.\n * @param guildIds The default guildIds to set. Set this to `null` to reset it to the default\n * of `undefined`.\n */\nexport function setDefaultGuildIds(guildIds?: ApplicationCommandRegistry.RegisterOptions['guildIds'] | null) {\n\tdefaultGuildIds = guildIds ?? undefined;\n}\n\nexport function getDefaultGuildIds() {\n\treturn defaultGuildIds;\n}\n\n/**\n * Sets the amount of retries for when registering commands, only applies when {@link defaultBehaviorWhenNotIdentical}\n * is set to {@link RegisterBehavior.BulkOverwrite}. This is used if registering the commands times out.\n * The default value is `1`, which means no retries are performed.\n * @param newAmountOfRetries The new amount of retries to set. Set this to `null` to reset it to the default\n */\nexport function setBulkOverwriteRetries(newAmountOfRetries: number | null) {\n\tnewAmountOfRetries ??= 1;\n\n\tif (newAmountOfRetries <= 0) throw new RangeError('The amount of retries must be greater than 0');\n\n\tbulkOVerwriteRetries = newAmountOfRetries;\n}\n\nexport function getBulkOverwriteRetries() {\n\treturn bulkOVerwriteRetries;\n}\n\nexport async function handleRegistryAPICalls() {\n\tcontainer.client.emit(Events.ApplicationCommandRegistriesInitialising);\n\n\tconst commandStore = container.stores.get('commands');\n\n\tfor (const command of commandStore.values()) {\n\t\tif (command.registerApplicationCommands) {\n\t\t\ttry {\n\t\t\t\tawait command.registerApplicationCommands(command.applicationCommandRegistry);\n\t\t\t} catch (error) {\n\t\t\t\temitPerRegistryError(error, command);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (getDefaultBehaviorWhenNotIdentical() === RegisterBehavior.BulkOverwrite) {\n\t\tawait handleBulkOverwrite(commandStore, container.client.application!.commands);\n\t\treturn;\n\t}\n\n\tconst params = await getNeededRegistryParameters(allGuildIdsToFetchCommandsFor);\n\n\tawait handleAppendOrUpdate(commandStore, params);\n}\n\nexport async function handleBulkOverwrite(commandStore: CommandStore, applicationCommands: ApplicationCommandManager) {\n\tconst now = Date.now();\n\n\t// Map registries by guild, global, etc\n\tconst foundGlobalCommands: BulkOverwriteData[] = [];\n\tconst foundGuildCommands: Record<string, BulkOverwriteData[]> = {};\n\n\t// Collect all data\n\tfor (const command of commandStore.values()) {\n\t\tconst registry = command.applicationCommandRegistry;\n\n\t\tfor (const call of registry['apiCalls']) {\n\t\t\t// Guild only cmd\n\t\t\tif (call.registerOptions.guildIds?.length) {\n\t\t\t\tfor (const guildId of call.registerOptions.guildIds) {\n\t\t\t\t\tfoundGuildCommands[guildId] ??= [];\n\n\t\t\t\t\tfoundGuildCommands[guildId].push({ piece: command, data: call.builtData });\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Global command\n\t\t\tfoundGlobalCommands.push({ piece: command, data: call.builtData });\n\t\t}\n\t}\n\n\t// Handle global commands\n\tawait retry(() => handleBulkOverwriteGlobalCommands(commandStore, applicationCommands, foundGlobalCommands), bulkOVerwriteRetries);\n\n\t// Handle guild commands\n\tfor (const [guildId, guildCommands] of Object.entries(foundGuildCommands)) {\n\t\tawait retry(() => handleBulkOverwriteGuildCommands(commandStore, applicationCommands, guildId, guildCommands), bulkOVerwriteRetries);\n\t}\n\n\tcontainer.client.emit(Events.ApplicationCommandRegistriesRegistered, registries, Date.now() - now);\n}\n\nasync function handleBulkOverwriteGlobalCommands(\n\tcommandStore: CommandStore,\n\tapplicationCommands: ApplicationCommandManager,\n\tfoundGlobalCommands: BulkOverwriteData[]\n) {\n\ttry {\n\t\tbulkOverwriteDebug(`Overwriting global application commands, now at ${foundGlobalCommands.length} commands`);\n\t\tconst result = await applicationCommands.set(foundGlobalCommands.map((x) => x.data));\n\n\t\t// Go through each registered command, find its piece and alias it\n\t\tfor (const [id, globalCommand] of result.entries()) {\n\t\t\tconst piece = foundGlobalCommands.find((x) => x.data.name === globalCommand.name)?.piece;\n\n\t\t\tif (piece) {\n\t\t\t\tconst registry = piece.applicationCommandRegistry;\n\n\t\t\t\tswitch (globalCommand.type) {\n\t\t\t\t\tcase ApplicationCommandType.ChatInput: {\n\t\t\t\t\t\tregistry['handleIdAddition'](InternalRegistryAPIType.ChatInput, id);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase ApplicationCommandType.User:\n\t\t\t\t\tcase ApplicationCommandType.Message: {\n\t\t\t\t\t\tregistry['handleIdAddition'](InternalRegistryAPIType.ContextMenu, id);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// idHints are useless, and any manually added id or names could end up not being valid any longer if you use bulk overwrites\n\t\t\t\t// That said, this might be an issue, so we might need to do it like `handleAppendOrUpdate`\n\t\t\t\tcommandStore.aliases.set(id, piece);\n\t\t\t} else {\n\t\t\t\tbulkOverwriteWarn(\n\t\t\t\t\t`Registered global command \"${globalCommand.name}\" (${id}) but failed to find the piece in the command store. This should not happen`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tbulkOverwriteInfo(`Successfully overwrote global application commands. The application now has ${result.size} global commands`);\n\t} catch (error) {\n\t\tif (error instanceof Error && error.name === 'AbortError') throw error;\n\n\t\temitBulkOverwriteError(error, null);\n\t}\n}\n\nasync function handleBulkOverwriteGuildCommands(\n\tcommandStore: CommandStore,\n\tapplicationCommands: ApplicationCommandManager,\n\tguildId: string,\n\tguildCommands: BulkOverwriteData[]\n) {\n\ttry {\n\t\tbulkOverwriteDebug(`Overwriting guild application commands for guild ${guildId}, now at ${guildCommands.length} commands`);\n\t\tconst result = await applicationCommands.set(\n\t\t\tguildCommands.map((x) => x.data),\n\t\t\tguildId\n\t\t);\n\n\t\t// Go through each registered command, find its piece and alias it\n\t\tfor (const [id, guildCommand] of result.entries()) {\n\t\t\t// I really hope nobody has a guild command with the same name as another command -.-\n\t\t\t// Not like they could anyways as Discord would throw an error for duplicate names\n\t\t\t// But yknow... If you're reading this and you did this... Why?\n\t\t\tconst piece = guildCommands.find((x) => x.data.name === guildCommand.name)?.piece;\n\n\t\t\tif (piece) {\n\t\t\t\tconst registry = piece.applicationCommandRegistry;\n\n\t\t\t\tswitch (guildCommand.type) {\n\t\t\t\t\tcase ApplicationCommandType.ChatInput: {\n\t\t\t\t\t\tregistry['handleIdAddition'](InternalRegistryAPIType.ChatInput, id, guildId);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase ApplicationCommandType.User:\n\t\t\t\t\tcase ApplicationCommandType.Message: {\n\t\t\t\t\t\tregistry['handleIdAddition'](InternalRegistryAPIType.ContextMenu, id, guildId);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// idHints are useless, and any manually added ids or names could no longer be valid if you use bulk overwrites.\n\t\t\t\t// That said, this might be an issue, so we might need to do it like `handleAppendOrUpdate`\n\t\t\t\tcommandStore.aliases.set(id, piece);\n\t\t\t} else {\n\t\t\t\tbulkOverwriteWarn(\n\t\t\t\t\t`Registered guild command \"${guildCommand.name}\" (${id}) but failed to find the piece in the command store. This should not happen`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tbulkOverwriteInfo(\n\t\t\t`Successfully overwrote guild application commands for guild ${guildId}. The application now has ${result.size} guild commands for guild ${guildId}`\n\t\t);\n\t} catch (error) {\n\t\tif (error instanceof Error && error.name === 'AbortError') throw error;\n\n\t\temitBulkOverwriteError(error, guildId);\n\t}\n}\n\nasync function handleAppendOrUpdate(\n\tcommandStore: CommandStore,\n\t{ applicationCommands, globalCommands, guildCommands }: Awaited<ReturnType<typeof getNeededRegistryParameters>>\n) {\n\tconst now = Date.now();\n\n\tfor (const registry of registries.values()) {\n\t\t// eslint-disable-next-line @typescript-eslint/dot-notation\n\t\tawait registry['runAPICalls'](applicationCommands, globalCommands, guildCommands);\n\n\t\tconst piece = registry.command;\n\n\t\tif (piece) {\n\t\t\tfor (const nameOrId of piece.applicationCommandRegistry.chatInputCommands) {\n\t\t\t\tcommandStore.aliases.set(nameOrId, piece);\n\t\t\t}\n\n\t\t\tfor (const nameOrId of piece.applicationCommandRegistry.contextMenuCommands) {\n\t\t\t\tcommandStore.aliases.set(nameOrId, piece);\n\t\t\t}\n\t\t}\n\t}\n\n\tcontainer.client.emit(Events.ApplicationCommandRegistriesRegistered, registries, Date.now() - now);\n}\n\ninterface BulkOverwriteData {\n\tpiece: Command;\n\tdata: RESTPostAPIApplicationCommandsJSONBody;\n}\n"]}