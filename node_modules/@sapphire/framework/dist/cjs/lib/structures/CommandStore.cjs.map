{"version":3,"sources":["../../../../src/lib/structures/CommandStore.ts"],"names":["AliasStore","Command","registries","emitPerRegistryError","getDefaultBehaviorWhenNotIdentical","RegisterBehavior","handleBulkOverwrite","getNeededRegistryParameters","allGuildIdsToFetchCommandsFor"],"mappings":"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","file":"CommandStore.cjs","sourcesContent":["import { AliasStore } from '@sapphire/pieces';\nimport type { Args } from '../parsers/Args';\nimport { RegisterBehavior } from '../types/Enums';\nimport {\n\tallGuildIdsToFetchCommandsFor,\n\tgetDefaultBehaviorWhenNotIdentical,\n\thandleBulkOverwrite,\n\tregistries\n} from '../utils/application-commands/ApplicationCommandRegistries';\nimport { getNeededRegistryParameters } from '../utils/application-commands/getNeededParameters';\nimport { emitPerRegistryError } from '../utils/application-commands/registriesErrors';\nimport { Command } from './Command';\n\n/**\n * Stores all Command pieces\n * @since 1.0.0\n */\nexport class CommandStore extends AliasStore<Command, 'commands'> {\n\tpublic constructor() {\n\t\tsuper(Command, { name: 'commands' });\n\t}\n\n\t/**\n\t * Get all the command categories.\n\t */\n\tpublic get categories(): string[] {\n\t\tconst categories = new Set(this.map((command) => command.category));\n\t\tcategories.delete(null);\n\t\treturn [...categories] as string[];\n\t}\n\n\tpublic override unload(name: string | Command): Promise<Command<Args, Command.Options>> {\n\t\tconst piece = this.resolve(name);\n\n\t\t// Remove the aliases from the store\n\t\tfor (const nameOrId of piece.applicationCommandRegistry.chatInputCommands) {\n\t\t\tconst aliasedPiece = this.aliases.get(nameOrId);\n\t\t\tif (aliasedPiece === piece) {\n\t\t\t\tthis.aliases.delete(nameOrId);\n\t\t\t}\n\t\t}\n\n\t\tfor (const nameOrId of piece.applicationCommandRegistry.contextMenuCommands) {\n\t\t\tconst aliasedPiece = this.aliases.get(nameOrId);\n\t\t\tif (aliasedPiece === piece) {\n\t\t\t\tthis.aliases.delete(nameOrId);\n\t\t\t}\n\t\t}\n\n\t\t// Remove the registry from the application command registries\n\t\tregistries.delete(piece.name);\n\n\t\treturn super.unload(name);\n\t}\n\n\tpublic override async loadAll() {\n\t\tawait super.loadAll();\n\n\t\t// If we don't have an application, that means this was called on login...\n\t\tif (!this.container.client.application) return;\n\n\t\t// super.loadAll() currently deletes all application command registries while unloading old pieces,\n\t\t// re-register application commands to ensure allGuildIdsToFetchCommandsFor has new guild ids for getNeededRegistryParameters\n\t\tfor (const command of this.values()) {\n\t\t\tif (command.registerApplicationCommands) {\n\t\t\t\ttry {\n\t\t\t\t\tawait command.registerApplicationCommands(command.applicationCommandRegistry);\n\t\t\t\t} catch (error) {\n\t\t\t\t\temitPerRegistryError(error, command);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// If the default behavior is set to bulk overwrite, handle it as such and return.\n\t\tif (getDefaultBehaviorWhenNotIdentical() === RegisterBehavior.BulkOverwrite) {\n\t\t\tawait handleBulkOverwrite(this, this.container.client.application.commands);\n\t\t\treturn;\n\t\t}\n\n\t\tconst { applicationCommands, globalCommands, guildCommands } = await getNeededRegistryParameters(allGuildIdsToFetchCommandsFor);\n\n\t\tfor (const command of this.values()) {\n\t\t\t// eslint-disable-next-line @typescript-eslint/dot-notation\n\t\t\tawait command.applicationCommandRegistry['runAPICalls'](applicationCommands, globalCommands, guildCommands);\n\n\t\t\t// Reinitialize the aliases\n\t\t\tfor (const nameOrId of command.applicationCommandRegistry.chatInputCommands) {\n\t\t\t\tthis.aliases.set(nameOrId, command);\n\t\t\t}\n\n\t\t\tfor (const nameOrId of command.applicationCommandRegistry.contextMenuCommands) {\n\t\t\t\tthis.aliases.set(nameOrId, command);\n\t\t\t}\n\t\t}\n\t}\n}\n"]}